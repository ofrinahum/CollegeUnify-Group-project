<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CollegeUnify</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>
    
        body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: linear-gradient(90deg, rgba(227, 207, 234, 1), rgba(240, 225, 246, 1));
        background-image: url('/images/registerBackground.png'); /* Add the path to your image */
        background-size: cover; /* Ensure the background image covers the entire viewport */
        background-position: center center; /* Center the image */
        background-repeat: no-repeat; /* Prevent the image from repeating */
        height: 100%; /* Set the height to always fill the viewport */
        width: 100vw; /* Ensure it fills the full width */
        overflow: hidden; /* Prevent scrollbars if not needed */
        }

        .event-study {
    background-color: #ddffde;
    border-color: #697e67;
    color: black !important; /* Ensure text is black */
}

    .event-study:hover{
    background-color: #a1b9a2; /* Adjust hover color */
    cursor: pointer; /* Show pointer cursor */
    }

.fc-event {
    white-space: normal; /* Allow text to wrap */
    overflow-wrap: break-word; /* Break long words if needed */
    word-wrap: break-word; /* Ensure compatibility with older browsers */
    line-height: 1.2; /* Improve text readability */
    padding: 2px; /* Add some padding for spacing */
    font-size: 12px; /* Adjust font size for better visibility */
}

            .event-homework {
            background-color: #edbf8e;
            border-color: #503d2a;
            color: black !important; /* Ensure text is black */
        }

        .event-homework:hover {
    background-color: #c6a178; /* Adjust hover color */
    cursor: pointer; /* Show pointer cursor */
}
        .event-project {
            background-color: #debdff;
            border-color: #6f508e;
            color: black !important; /* Ensure text is black */
        }

        .event-project:hover {
    background-color: #b28ae6; /* Adjust hover color */
    cursor: pointer; /* Show pointer cursor */
}

        /* Test: Red */
        .event-test {
            background-color: #e39797;
            border-color: #3c2323;
            color: black !important; /* Ensure text is black */
        }

        .event-test:hover {
    background-color: #a77070; /* Adjust hover color */
    cursor: pointer; /* Show pointer cursor */
}

        /* Personal: Purple */
        .event-personal {
            background-color: #adbcff;
            border-color: #212746;
            color: black !important; /* Ensure text is black */
        }

        .event-personal:hover {
    background-color: #6570a9; /* Adjust hover color */
    cursor: pointer; /* Show pointer cursor */
}
        /* Class: Orange */
        .event-class {
            background-color: #ede0a5;
            border-color: #766f51;
            color: black !important; /* Ensure text is black */
        }

        .event-class:hover {
    background-color: #b6ab7d; /* Adjust hover color */
    cursor: pointer; /* Show pointer cursor */
}

            .fc-event {
            color: black !important; /* Ensure all event text is black */
        }

        .fc-event-title {
            color: black !important; /* Specifically target the title text */
        }
        /* Ensure all event text, including times, is black */
        .fc-timegrid-event .fc-event-time,
        .fc-daygrid-event .fc-event-time,
        .fc-list-event .fc-event-time,
        .fc-event-title {
            color: black !important; /* Ensure text, including times, is black */
        }

        /* Override for all event text on all views */
        .fc-event,
        .fc-event .fc-time {
            color: black !important;
        }

        /* Specific override for times in timeGrid view */
        .fc-timegrid-event .fc-time {
            color: black !important; /* Ensure time is black in timeGrid view */
        }

        /* Specific override for times in dayGrid view */
        .fc-daygrid-event .fc-time {
            color: black !important; /* Ensure time is black in dayGrid view */
        }

        /* Specific override for list view */
        .fc-list-event-time {
            color: black !important; /* Ensure time is black in list view */
}

        /* Common navigation button styles */
        .nav-button {
        background-color: transparent;
        border: none; /* Remove border for all nav buttons */
        padding: 2.5px 12px;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        color: black;
        transition: background-color 0.3s, color 0.3s;
        }

        .nav-button:hover {
            background-color: #ececec; /* Subtle hover effect for white buttons */
            z-index: 2;
        }

        /* Specific styles for Sign In and Register buttons */
        .nav-button-signin {
            background-color: #F2F2F7;
            border: 1px solid black; /* Keep a border for these */
            z-index: 2;
        }

        .nav-button-signin:hover {
            background-color: #d9d9e7;
            z-index: 2;
        }

        .nav-button-register {
            background-color: #F7CDA0;
            border: 1px solid black; /* Keep a border for these */
            z-index: 2;
        }

        .nav-button-register:hover {
            background-color: #ECB171;
            z-index: 2;
        }

        /* Navigation Bar Logo */
        .navbar-logo {
            margin-left: -10px;
            margin-bottom: 3px;
            cursor: pointer;
            z-index:2
        }

        .cta-button {
            background-color: #F7CDA0;
            color: black;
            font-size: 16px;
            border: 1px solid black;
            border-radius: 5px;
            width: 220px;
            height: 53px;
            cursor: pointer;
            margin-top: 30px;
            margin-left: 60px;
            transition: background-color 0.3s ease-in-out;
        }

        .cta-button:hover {
            background-color: #ECB171;
        }
        
    </style>
</head>
<body style="margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; overflow-y: scroll;">
    <!-- Navigation Bar -->
    <div style="background-color: white; padding: 10px; position: relative; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); height: 70px; z-index: 2;">
        <div style="margin-right: 50px; display: flex; justify-content: space-between; align-items: center; max-width: 1440px; margin: 0 auto; height: 100%;  z-index: 2;">
            <!-- Logo (Now as a Button) -->
            <a href="/dashboard" class="navbar-logo">
                <img src="/images/CULogo.png" alt="Logo" style="width: 55.5px; height: 50px; margin-left: -8.5px">
            </a>
            <div style="display: flex; gap: 15px; margin-right: 18.5px; z-index:2">
                <button onclick="location.href='#chat'" class="nav-button">Chat</button>
                <button onclick="location.href='#resources'" class="nav-button">Resources</button>
                <button onclick="location.href='/tasks'" class="nav-button">My Tasks</button>
                <button onclick="location.href='/dashboard'" class="nav-button">Dashboard</button>
                <button onclick="location.href='#settings'" class="nav-button nav-button-signin">Settings</button>
                <button onclick="location.href='/logout'" class="nav-button nav-button-register">Logout</button>
            </div>
        </div>
    </div>

    <div style="display: flex; align-items: flex-start; gap: 20px; margin: 20px;">
        <!-- Calendar Container -->
        <div style="
            background-color: rgba(254, 252, 249, 0.95); 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); 
            max-width: 1200px; 
            flex: 3;
            margin-left: 60px;">
              <div style="font-family: Arial, sans-serif; font-size: 18px; color: #333; text-align: center;">
                Here's an overview of your upcoming tasks for:
            </div>
            <div id="calendar"></div>
        </div>
    
        <!-- Manage Tasks Button -->
        <button onclick="location.href='/tasks'" class="cta-button">Manage Tasks</button>
    </div>

    
    <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Task Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- Task details will be dynamically inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    

    <script>
  document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth', // Set the initial view
    headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    slotDuration: '00:15:00', // 15-minute intervals
    slotLabelInterval: '01:00', // Labels every hour
    slotLabelFormat: {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true // Adjust for 12-hour or 24-hour format
    },
    visibleRange: function(currentDate) {
        // Calculate the start and end of the current month
        let start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        let end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0); // Last day of the current month

        return {
            start: start.toISOString().split('T')[0], // Start of the month
            end: end.toISOString().split('T')[0]     // End of the month
        };
    },
        events: function (info, successCallback, failureCallback) {
    fetch('/tasks/api') // Fetch tasks from the server
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch tasks');
            }
            return response.json();
        })
        .then(data => {
            const events = [];
            
            data.forEach(task => {
    if (task.type === 'class' && task.repeatPattern) {
        addRepeatingEvents(task, events, info.start, info.end);
    } else {
        let start = null;
        let end = null;
        let allDay = true; // Default to all-day unless we have times

        if (task.dueDate && task.dueTime) {
            // Handle due time of 11:59 PM explicitly
            if (task.dueTime === '23:59:00') {
                start = `${task.dueDate}T23:59:00`;
                end = `${task.dueDate}T23:59:59`;; // Avoid setting an explicit end time
                allDay = false; // Mark as a timed event
            } else {
                start = `${task.dueDate}T${task.dueTime}`;
                end = `${task.dueDate}T${task.dueTime}`;
                allDay = false;
            }
        } else if (task.eventDate && task.startTime) {
            start = `${task.eventDate}T${task.startTime}`;
            end = task.endTime ? `${task.eventDate}T${task.endTime}` : null;
            allDay = false;
        }

        events.push({
            id: task.id,
            title: `${task.title} (${task.type})`,
            start: start,
            end: end,
            description: task.description || '',
            allDay: allDay,
            extendedProps: {
                type: task.type,
                priority: task.priority,
                repeatPattern: task.repeatPattern,
                repeatDays: task.repeatDays,
                startDate: task.startDate,
                endDate: task.endDate,
                eventDate: task.eventDate,
                dueDate: task.dueDate,
                dueTime: task.dueTime,
                startTime: task.startTime,
                endTime: task.endTime
            },
            className: `event-${task.type.toLowerCase()}`
        });

        // Add study events
        addStudyEvents(task, events);
    }
});
            successCallback(events);
        })
        .catch(error => {
            console.error('Error fetching tasks:', error);
            failureCallback(error);
        });
},

        eventClick: function (info) {
    // Get task details from the event
    const task = info.event.extendedProps;

    let modalContent = `<p><strong>Title:</strong> ${info.event.title}</p>`;
    modalContent += `<p><strong>Description:</strong> ${task.description || 'N/A'}</p>`;

    if(task.type === 'homework' || task.type === 'project') {
            modalContent += `<p><strong>Priority:</strong> ${task.priority || 'N/A'}</p>`;
            modalContent += `<p><strong>Due Date:</strong> ${task.dueDate || 'N/A'}</p>`;
            modalContent += `<p><strong>Due Time:</strong> ${task.dueTime || 'N/A'}</p>`;
              }
    if(task.type === 'test'){
            modalContent += `<p><strong>Priority:</strong> ${task.priority || 'N/A'}</p>`;
            modalContent += `<p><strong>Event Date:</strong> ${task.eventDate || 'N/A'}</p>`;
            modalContent += `<p><strong>Start Time:</strong> ${task.startTime || 'N/A'}</p>`;
            modalContent += `<p><strong>End Time:</strong> ${task.endTime || 'N/A'}</p>`;
    }

    if (task.type ==='personal'){
            modalContent += `<p><strong>Event Date:</strong> ${task.eventDate || 'N/A'}</p>`;
            modalContent += `<p><strong>Start Time:</strong> ${task.startTime || 'N/A'}</p>`;
            modalContent += `<p><strong>End Time:</strong> ${task.endTime || 'N/A'}</p>`;
    }

    if(task.type === 'class'){
            modalContent += `<p><strong>Start Time:</strong> ${task.startTime || 'N/A'}</p>`;
            modalContent += `<p><strong>End Time:</strong> ${task.endTime || 'N/A'}</p>`;
            modalContent += `<p><strong>Frequency:</strong> ${task.repeatPattern || 'N/A'}</p>`;
            modalContent += `<p><strong>Repeat Days:</strong> ${task.repeatDays ? task.repeatDays.join(', ') : 'N/A'}</p>`;
            modalContent += `<p><strong>Start Date:</strong> ${task.startDate || 'N/A'}</p>`;
            modalContent += `<p><strong>End Date:</strong> ${task.endDate || 'N/A'}</p>`;
    }

    // Populate the modal and show it
    document.getElementById('eventModalBody').innerHTML = modalContent;
    $('#eventModal').modal('show');
}

    });

    calendar.render();
});

/**
 * Add repeating events for a task based on its pattern.
 */
function addRepeatingEvents(task, events, viewStart, viewEnd) {
    const startDate = new Date(task.startDate); // Class start date
    const endDate = task.endDate ? new Date(task.endDate) : null; // Class end date (optional)
    const repeatDays = task.repeatDays || []; // Days of the week the task repeats (e.g., ["Monday", "Wednesday"])
    const repeatPattern = task.repeatPattern.toLowerCase(); // "daily", "weekly", etc.
    const taskStartTime = task.startTime || '00:00:00';
    const taskEndTime = task.endTime || '23:59:59';

    // Convert repeat days to numeric representation (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
    const dayMap = {
        Sunday: 0,
        Monday: 1,
        Tuesday: 2,
        Wednesday: 3,
        Thursday: 4,
        Friday: 5,
        Saturday: 6
    };
    const repeatDayNumbers = repeatDays.map(day => dayMap[day]);

    // Loop through the view range to generate repeating events
    let currentDate = new Date(viewStart);

    while (currentDate <= viewEnd) {
        // Skip dates outside the task's date range
        if (currentDate < startDate || (endDate && currentDate > endDate)) {
            currentDate.setDate(currentDate.getDate() + 1); // Move to next day
            continue;
        }

        // Check if the current date matches the repeat pattern
        const isMatchingDay =
            repeatPattern === 'daily' || // Always matches for daily
            (repeatPattern === 'weekly' && repeatDayNumbers.includes(currentDate.getDay())); // Matches for weekly

        if (isMatchingDay) {
            // Add event for the matching day
            const eventStart = `${currentDate.toISOString().split('T')[0]}T${taskStartTime}`;
            const eventEnd = `${currentDate.toISOString().split('T')[0]}T${taskEndTime}`;
            events.push({
    id: task.id,
    title: `${task.title} (${task.type === 'class' ? 'repeating' : task.type})`, // Include type in title
    start: eventStart,
    end: eventEnd,
    description: task.description || '',
    allDay: false,
    className: `event-${task.type.toLowerCase()}`, // Apply class for styling
    extendedProps: {
        type: task.type,
        priority: task.priority,
        repeatPattern: task.repeatPattern,
        repeatDays: task.repeatDays,
        startDate: task.startDate,
        endDate: task.endDate,
        eventDate: task.eventDate,
        dueDate: task.dueDate,
        dueTime: task.dueTime,
        startTime: task.startTime,
        endTime: task.endTime
    }
});
        }

        // Move to the next day
        currentDate.setDate(currentDate.getDate() + 1);
    }
}

/**
 * Add study events for a task based on its priority.
 */
 function addStudyEvents(task, events) {
    const priorityToHours = {
        low: 5,
        medium: 10,
        high: 15
    };

    // Skip study time for personal and class types
    if (task.type === 'personal' || task.type === 'class') {
        return;
    }

    const totalStudyHours = priorityToHours[task.priority?.toLowerCase()] || 0; // Default to 0 if no priority
    if (totalStudyHours === 0) return;

    const studyStartDate = new Date(task.dueDate || task.eventDate);
    studyStartDate.setDate(studyStartDate.getDate() - 1); // Start allocating from the day before the event

    const studyDays = 3; // Spread study time over 3 days
    const dailyStudyHours = Math.ceil(totalStudyHours / studyDays); // Hours per day

    for (let day = 0; day < studyDays; day++) {
        const studyDate = new Date(studyStartDate);
        studyDate.setDate(studyDate.getDate() - day);

        // Find free time slots for the day
        const freeSlots = getFreeTimeSlots(events, studyDate);

        let remainingHours = dailyStudyHours;

        // Fit study sessions into free slots
        for (const slot of freeSlots) {
            if (remainingHours <= 0) break;

            const slotStart = new Date(slot.start);
            const slotEnd = new Date(slot.end);
            const availableHours = (slotEnd - slotStart) / (1000 * 60 * 60);

            // Allocate the minimum between remaining hours and available slot time
            const sessionHours = Math.min(remainingHours, availableHours);
            const sessionEnd = new Date(slotStart);
            sessionEnd.setHours(slotStart.getHours() + sessionHours);

            // Define title based on the task type
            let titlePrefix = 'Study for';
            if (task.type === 'homework') {
                titlePrefix = 'Work on Homework';
            } else if (task.type === 'project') {
                titlePrefix = 'Work on Project';
            }

            events.push({
                id: `${task.id}-study-${day}-${slot.start}`,
                title: `${titlePrefix}: ${task.title}`,
                start: slotStart.toISOString(),
                end: sessionEnd.toISOString(),
                description: `Allocated time for ${task.title} (${task.priority} priority)`,
                className: 'event-study', // Class for styling
                allDay: false,
                extendedProps: {
                    relatedTask: task.id,
                    priority: task.priority
                }
            });

            // Reduce remaining hours
            remainingHours -= sessionHours;
        }
    }
}

/**
 * Get free time slots for a specific day based on existing events.
 */
function getFreeTimeSlots(events, date) {
    const dayStart = new Date(date);
    dayStart.setHours(8, 0, 0, 0); // Start of the day (8 AM)
    const dayEnd = new Date(date);
    dayEnd.setHours(22, 0, 0, 0); // End of the day (10 PM)

    // Filter events for the specific day
    const dayEvents = events.filter(event => {
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        return eventStart.toDateString() === date.toDateString() ||
               eventEnd.toDateString() === date.toDateString();
    });

    // Sort events by start time
    dayEvents.sort((a, b) => new Date(a.start) - new Date(b.start));

    // Find free slots
    const freeSlots = [];
    let lastEnd = dayStart;

    for (const event of dayEvents) {
        const eventStart = new Date(event.start);

        // Check if there is a gap between the last end time and the current event's start time
        if (eventStart > lastEnd) {
            freeSlots.push({ start: lastEnd, end: eventStart });
        }

        // Update lastEnd to the maximum of its current value or the event's end time
        lastEnd = new Date(Math.max(lastEnd, new Date(event.end)));
    }

    // Add the slot between the last event and the end of the day
    if (lastEnd < dayEnd) {
        freeSlots.push({ start: lastEnd, end: dayEnd });
    }

    return freeSlots;
}



    </script>
</body>
</html>